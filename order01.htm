<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>電子點名表單</title>
<style>
    /* 可選：讓表單更好看一點 */
    body { font-family: Arial, sans-serif; margin: 0px; }
    
    /* 修正：讓 form#myForm 獨立出來，方便控制 */
    form#myForm { 
        width: 100%; /* 讓表單填滿 centered-box */
        padding: 10px; 
        box-sizing: border-box; 
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    label, input, select, button { display: block; margin-bottom: 10px; }
    input[type="text"], input[type="number"], select { 
        width: 70%; 
        padding: 8px; 
        box-sizing: border-box; 
    }
    button { 
        padding: 10px 15px; 
        background-color: #4CAF50; 
        color: white; 
        border: none; 
        cursor: pointer; 
    }

.centered-box {
    display: flex;
    justify-content: center; /* 水平置中 */
    align-items: center;      /* 垂直置中 */
    flex-direction: column; /* 確保內容垂直排列 */
    width: 70%;
    margin: 20px auto; /* 置中並加點上下邊距 */
    background-color: #e0f0ff; /* 淺藍底色 */
    border-radius: 15px; /* 圓角 */
    padding: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    text-align: center;
}

.la {
    margin: 10px 0;
    font-size:1.5em;
    text-align: center;
}

.form {
    width: 100%; /* 確保 .form 寬度足夠 */
}
</style>
</head>
<body>

<div class="centered-box">
    
    <div class="form">
        <h1>電子點名</h1>
        
        <form id="myForm">
            <table border="0" width="500">
                <tr>
                    <td colspan="2" align="center">
                        <input type="hidden" id="backurl" value="https://lanu7870056.github.io/600/order01.htm" name="backurl">
                        <input class="la" type="text" id="gmail" name="GMAIL" style="background-color: #d3d3d3;" readonly>
                    </td>
                </tr>
                <tr>
                    <td style="width: 80px;"><label class="la" for="classId">班級:</label></td>
                    <td style="width: 420px;">
                        <select class="la" id="classId" name="班級" required>
                            <option value="">-- 請選擇班級 --</option>
                            <option value="101">101</option>
                            <option value="102">102</option>
                            <option value="103">103</option>
                            <option value="104">104</option>
                            <option value="105">105</option>
                            <option value="108">108</option>
                            <option value="109">109</option>
                            <option value="110">110</option>
                            <option value="111">111</option>
                            <option value="113">113</option>
                            <option value="114">114</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td style="width: 80px;"><label class="la" for="seatNum">座號：</label></td>
                    <td>
                        <input class="la" type="number" id="seatNum" name="座號" min="1" max="50" required>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" align="center">
                        <button class="la" type="submit">送出資料</button>
                    </td>
                </tr>
            </table>
        </form>
    </div> <p id="responseMessage" style="margin-top: 20px; font-weight: bold;"></p>

</div> <script>
let A = localStorage.getItem("GM");  //取出
if (A) {
    document.getElementById('gmail').value = A;
}


    // ⚠️ 這是您 Apps Script 的 Web App URL，請確認它是否正確
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbysGyVzYeLYlX_hxlff_KoCgXZma1ayMujEl8D4bq0jsPOmM8Gd6p9sofIdzt2my325/exec";  
    
    document.getElementById('myForm').addEventListener('submit', async function(event) {
        // ⭐️ 阻止瀏覽器執行傳統提交 (關鍵步驟，讓網址欄不變)
        event.preventDefault(); 

        const form = event.target;
        
        // --- 🎯 必填欄位檢查邏輯 🎯 ---
        const classId = document.getElementById('classId').value;
        const seatNum = document.getElementById('seatNum').value;
        const responseMessage = document.getElementById('responseMessage');
        
        responseMessage.textContent = ''; // 清空舊訊息

        if (classId === "") {
            // 班級未選擇時，彈出視窗提醒
            alert("請選擇班級！"); 
            responseMessage.textContent = '⚠️ 請選擇班級後再送出資料。';
            responseMessage.style.color = 'orange';
            return; // 停止執行後續程式碼，阻止送出
        }

        if (seatNum === "") {
            // 座號未輸入時，彈出視窗提醒
            alert("請輸入座號！"); 
            responseMessage.textContent = '⚠️ 請輸入座號後再送出資料。';
            responseMessage.style.color = 'orange';
            return; // 停止執行後續程式碼，阻止送出
        }
        // --- 🎯 檢查邏輯結束 🎯 ---

        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => { data[key] = value; });

        responseMessage.textContent = '資料處理中...';
        responseMessage.style.color = 'blue';

        try {
            const response = await fetch(APP_SCRIPT_URL, {
                method: 'POST',
                // 將數據轉換為 Apps Script 期望的格式
                body: new URLSearchParams(data)  
            });

            if (!response.ok) {
                throw new Error(`伺服器 HTTP 錯誤: ${response.status}`);
            }

            // ⭐️ 解析 Apps Script 回傳的 JSON 狀態
            const result = await response.json(); 

            if (result.status === 'duplicate') {
                // 🚨 資料重複：在當前頁面彈窗並更新訊息
                alert("報到重覆，系統自動扣1分");  
                responseMessage.textContent = '❌ ' + result.message;
                responseMessage.style.color = 'red';
            } else if (result.status === 'success') {
                // ✅ 資料新增成功
                alert("資料送出成功！");
                responseMessage.textContent = '✅ ' + result.message;
                responseMessage.style.color = 'green';
                form.reset(); // 清空表單欄位
            } else {
                // 處理 Apps Script 回傳的其它錯誤 (如座號範圍錯誤)
                alert("資料處理錯誤：" + result.message);
                responseMessage.textContent = '⚠️ ' + result.message;
                responseMessage.style.color = 'orange';
            }

        } catch (error) {
            alert("網路連線或 Apps Script 錯誤！");
            responseMessage.textContent = '❌ 連線失敗: ' + error.message;
            responseMessage.style.color = 'red';
        }
    });
</script>

</body>
</html>