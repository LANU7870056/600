<meta charset="UTF-8">
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apps Script è‡ªå‹•æŸ¥è©¢å·¥å…·</title>
</head>
<body>

<hr>

<p>
    <strong>æœ¬é å®Œæ•´ç¶²å€ (é€å‡º):</strong> <span id="fullUrlDisplay" style="color: grey;"></span><br>
    <span id="idSearchedDisplay" style="color: orange;"></span><br>
    <strong>å›å‚³ KEY å€¼:</strong> <span id="keyResult" style="color: blue; font-weight: bold;"></span>
</p>
<p id="message" style="color: red;"></p>

<script>
// ã€é‡è¦ã€‘è«‹å°‡é€™è£¡æ›¿æ›ç‚ºæ‚¨åœ¨æ­¥é©ŸäºŒéƒ¨ç½²å¾Œç²å¾—çš„ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzU1nR97egwNLFzixe9eTe7JpYs7H6Z_t3Yar9u1Wl4RR0Isbq2JvPWw881ja4ZyoLP/exec";

function queryKeyFromUrl() {
    const fullUrl = window.location.href; // ç²å–æœ¬æ©Ÿç¶²å€
    
    const urlDisplay = document.getElementById('fullUrlDisplay');
    const idDisplay = document.getElementById('idSearchedDisplay');
    const keyResult = document.getElementById('keyResult');
    const message = document.getElementById('message');
    
    urlDisplay.textContent = fullUrl;
    idDisplay.textContent = '... æ­£åœ¨æå– ID';
    keyResult.textContent = '... æ­£åœ¨æŸ¥è©¢';
    message.textContent = '';
    
    if (WEB_APP_URL === "YOUR_NEW_CODE2.GS_WEB_APP_URL") {
        message.textContent = "è«‹å…ˆæ›¿æ› WEB_APP_URL è®Šæ•¸ã€‚";
        return;
    }
    
    // æ§‹é€ å¸¶æœ‰ 'referer_url' åƒæ•¸çš„ URL
    const queryUrl = `${WEB_APP_URL}?referer_url=${encodeURIComponent(fullUrl)}`;

    fetch(queryUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
            }
            return response.json(); 
        })
        .then(data => {
            // é¡¯ç¤º Apps Script è™•ç†çš„ ID
            idDisplay.textContent = `æå–ä¸¦è½‰æ›çš„ ID: ${data.id_searched || 'N/A'}`;
            
            if (data.status === "success" && data.key) {
                // æˆåŠŸå›å‚³ KEY
                keyResult.textContent = data.key; 
                message.textContent = data.message || ''; // é¡¯ç¤ºé è¨­å€¼æç¤º (å¦‚æœæœ‰çš„è©±)
            } else if (data.status === "not_found") {
                // ID åœ¨è©¦ç®—è¡¨ä¸­æœªæ‰¾åˆ° (ç†è«–ä¸Šæ–°ç‰ˆ GS ä¸æœƒèµ°åˆ°é€™è£¡ï¼Œæœƒå›å‚³é è¨­å€¼)
                keyResult.textContent = 'æœªæ‰¾åˆ°';
                message.textContent = `æŸ¥è©¢å¤±æ•—: ${data.error}`;
            } else if (data.error) {
                // Apps Script åŸ·è¡ŒéŒ¯èª¤
                keyResult.textContent = 'åŸ·è¡ŒéŒ¯èª¤';
                message.textContent = `Apps Script éŒ¯èª¤: ${data.error}`;
            } else {
                // æœªçŸ¥éŒ¯èª¤
                keyResult.textContent = 'å¤±æ•—';
                message.textContent = 'æŸ¥è©¢å¤±æ•—ï¼Œå›å‚³æ ¼å¼éŒ¯èª¤ã€‚';
            }
        })
        .catch(error => {
            console.error('Fetch éŒ¯èª¤:', error);
            keyResult.textContent = 'é€£ç·šéŒ¯èª¤';
            message.textContent = `ç„¡æ³•é€£ç·šåˆ° Google Script: ${error.message}`;
        });
}

// ğŸš¨ ç¶²é è¼‰å…¥å®Œæˆå¾Œï¼Œè‡ªå‹•åŸ·è¡Œè«‹æ±‚
queryKeyFromUrl(); 
</script>

</body>
</html>