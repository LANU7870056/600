<meta charset="UTF-8">
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apps Script 自動查詢工具</title>
</head>
<body>

<hr>

<p>
    <strong>本頁完整網址 (送出):</strong> <span id="fullUrlDisplay" style="color: grey;"></span><br>
    <span id="idSearchedDisplay" style="color: orange;"></span><br>
    <strong>回傳 KEY 值:</strong> <span id="keyResult" style="color: blue; font-weight: bold;"></span>
</p>
<p id="message" style="color: red;"></p>

<script>
// 【重要】請將這裡替換為您在步驟二部署後獲得的「網路應用程式網址」
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzU1nR97egwNLFzixe9eTe7JpYs7H6Z_t3Yar9u1Wl4RR0Isbq2JvPWw881ja4ZyoLP/exec";

function queryKeyFromUrl() {
    const fullUrl = window.location.href; // 獲取本機網址
    
    const urlDisplay = document.getElementById('fullUrlDisplay');
    const idDisplay = document.getElementById('idSearchedDisplay');
    const keyResult = document.getElementById('keyResult');
    const message = document.getElementById('message');
    
    urlDisplay.textContent = fullUrl;
    idDisplay.textContent = '... 正在提取 ID';
    keyResult.textContent = '... 正在查詢';
    message.textContent = '';
    
    if (WEB_APP_URL === "YOUR_NEW_CODE2.GS_WEB_APP_URL") {
        message.textContent = "請先替換 WEB_APP_URL 變數。";
        return;
    }
    
    // 構造帶有 'referer_url' 參數的 URL
    const queryUrl = `${WEB_APP_URL}?referer_url=${encodeURIComponent(fullUrl)}`;

    fetch(queryUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
            }
            return response.json(); 
        })
        .then(data => {
            // 顯示 Apps Script 處理的 ID
            idDisplay.textContent = `提取並轉換的 ID: ${data.id_searched || 'N/A'}`;
            
            if (data.status === "success" && data.key) {
                // 成功回傳 KEY
                keyResult.textContent = data.key; 
                message.textContent = data.message || ''; // 顯示預設值提示 (如果有的話)
            } else if (data.status === "not_found") {
                // ID 在試算表中未找到 (理論上新版 GS 不會走到這裡，會回傳預設值)
                keyResult.textContent = '未找到';
                message.textContent = `查詢失敗: ${data.error}`;
            } else if (data.error) {
                // Apps Script 執行錯誤
                keyResult.textContent = '執行錯誤';
                message.textContent = `Apps Script 錯誤: ${data.error}`;
            } else {
                // 未知錯誤
                keyResult.textContent = '失敗';
                message.textContent = '查詢失敗，回傳格式錯誤。';
            }
        })
        .catch(error => {
            console.error('Fetch 錯誤:', error);
            keyResult.textContent = '連線錯誤';
            message.textContent = `無法連線到 Google Script: ${error.message}`;
        });
}

// 🚨 網頁載入完成後，自動執行請求
queryKeyFromUrl(); 
</script>

</body>
</html>